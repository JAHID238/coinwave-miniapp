<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>CoinWave â€” Mini Earnings App</title>
  <style>
    :root { --primary:#0088cc; --bg:#f3f5fa; }
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,Arial;background:var(--bg);color:#111}
    header{padding:16px;text-align:center;background:var(--primary);color:#fff;font-weight:700}
    .wrap{max-width:780px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:16px}
    @media (min-width:720px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:#fff;border-radius:16px;padding:18px;box-shadow:0 8px 24px rgba(0,0,0,.08)}
    .title{margin:0 0 8px;font-size:18px;font-weight:700}
    .muted{color:#667; font-size:14px}
    .balance{font-size:28px;font-weight:800;color:var(--primary)}
    .row{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .btn{display:inline-block;padding:12px 16px;border-radius:12px;background:linear-gradient(90deg,#00b7ff,#0077ff);color:#fff;text-decoration:none;font-weight:700;box-shadow:0 6px 16px rgba(0,123,255,.25);transition:.2s}
    .btn:hover{opacity:.9}
    .btn-outline{background:#fff;color:var(--primary);border:1px solid #cfe8ff}
    .ad-box{min-height:100px;border:1px dashed #cfd8e3;border-radius:12px;display:flex;align-items:center;justify-content:center;color:#778;padding:8px}
    .task{border:1px solid #eef2f8;border-radius:12px;padding:12px;margin:10px 0}
    .progress{height:12px;background:#eef2f8;border-radius:12px;overflow:hidden}
    .bar{height:100%;width:0%;background:linear-gradient(90deg,#00e1ff,#0088cc);transition:.4s}
    pre{background:#f6f7fb;padding:12px;border-radius:10px;overflow:auto}
    .note{font-size:12px;color:#6b7280;margin-top:6px}
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<header>ğŸ’ CoinWave â€” Mini Earnings App</header>

<div class="wrap">

  <div class="grid">
    <!-- Balance / Actions -->
    <div class="card">
      <p class="title">ğŸ”¢ Balance</p>
      <div class="balance"><span id="balance">0</span> ğŸª™</div>
      <div class="progress" style="margin:10px 0 14px"><div class="bar" id="bar"></div></div>
      <div class="row" style="gap:10px;flex-wrap:wrap">
        <a href="#" class="btn" id="dailyBtn">ğŸ Daily Bonus</a>
        <a href="#" class="btn btn-outline" id="withdrawBtn">ğŸ’µ Withdraw</a>
      </div>
      <div class="note">Tip: Daily bonus à¦¨à¦¿à¦²à§‡à¦‡ streak à¦¬à¦¾à§œà§‡, à¦¬à§‡à¦¶à¦¿ reward à¦ªà¦¾à¦¬à§‡à¥¤</div>
    </div>

    <!-- User -->
    <div class="card">
      <p class="title">ğŸ‘¤ Profile</p>
      <pre id="user">Loading...</pre>
      <div class="note">Referral: Bot link à¦¦à¦¿à§Ÿà§‡ à¦‡à¦¨à¦­à¦¾à¦‡à¦Ÿ à¦•à¦°à¦²à§‡ bonus à¦ªà¦¾à¦“à§Ÿà¦¾ à¦¯à¦¾à¦¬à§‡à¥¤</div>
    </div>
  </div>

  <!-- Tasks -->
  <div class="card">
    <p class="title">ğŸ”¥ Tasks</p>

    <div class="task">
      <div class="row"><b>â–¶ Watch Banner (300Ã—250)</b> <a href="#" class="btn claim" data-amount="10" data-ad="banner">Claim 10</a></div>
      <div id="banner" class="ad-box">Click â€œClaim 10â€ â†’ Ad loads here â†’ Wait 5s â†’ Coins added</div>
    </div>

    <div class="task">
      <div class="row"><b>â–¶ Watch Native Ad</b> <a href="#" class="btn claim" data-amount="15" data-ad="native">Claim 15</a></div>
      <div id="native" class="ad-box">Click â€œClaim 15â€ â†’ Ad loads here â†’ Wait 5s â†’ Coins added</div>
    </div>

    <div class="task">
      <div class="row"><b>ğŸ“ Complete Survey</b> <a href="#" class="btn claim" data-amount="20" data-ad="">Claim 20</a></div>
      <div class="note">Survey external à¦¹à¦²à§‡ redirect à¦¦à§‡à¦–à¦¾à¦¤à§‡ à¦ªà¦¾à¦°à§‹; backend validate à¦•à¦°à¦¬à§‡à¥¤</div>
    </div>
  </div>

  <!-- Leaderboard -->
  <div class="card">
    <p class="title">ğŸ† Top Earners</p>
    <div id="board" class="muted">Loadingâ€¦</div>
  </div>

  <!-- Policy -->
  <div class="card">
    <p class="title">âš ï¸ Ad Policy</p>
    <div class="muted">Popunder/force-click à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦•à§‹à¦°à§‹ à¦¨à¦¾â€”Telegram/Ad network à¦¬à§à¦²à¦• à¦•à¦°à¦¤à§‡ à¦ªà¦¾à¦°à§‡à¥¤ à¦¶à§à¦§à§à¦®à¦¾à¦¤à§à¦° in-page banner/native à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦•à¦°à§‹à¥¤</div>
  </div>

</div>

<script>
  // ---- Telegram init ----
  const tg = window.Telegram?.WebApp;
  if (tg) tg.expand();

  // State
  let user = null;
  const $ = (s)=>document.querySelector(s);
  const balanceEl = $('#balance');
  const barEl = $('#bar');
  const setBalance = (v)=>{ balanceEl.textContent = v; barEl.style.width = Math.min((v%100)/100*100,100)+'%'; };

  // Helpers
  const api = (p, data)=>fetch(p,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data||{})}).then(r=>r.json());

  // Load user + leaderboard
  async function boot(){
    const payload = { initData: tg?.initData || '', initDataUnsafe: tg?.initDataUnsafe || null };
    const info = await api('/api/user', payload);
    if(!info.success){ alert(info.message||'Auth failed'); return; }
    user = info.user;
    setBalance(user.coins||0);
    $('#user').textContent = JSON.stringify({
      id:user.tgId, name:user.first_name+' '+(user.last_name||''), username:user.username, lang:user.language_code, streak:user.streak||0
    }, null, 2);

    const lb = await api('/api/leaderboard',{});
    if(lb.success){
      $('#board').innerHTML = lb.top.map((u,i)=>`#${i+1} â€” ${u.username||('User'+u.tgId)} â€” <b>${u.coins}</b>ğŸª™`).join('<br>');
    }
  }

  // Daily Bonus
  $('#dailyBtn').addEventListener('click', async (e)=>{
    e.preventDefault();
    const res = await api('/api/daily',{ initData: tg?.initData||'', initDataUnsafe: tg?.initDataUnsafe||null });
    if(!res.success){ alert(res.message||'Daily failed'); return; }
    setBalance(res.coins);
    alert('âœ… Daily bonus: +'+res.added+' coins (streak '+res.streak+')');
  });

  // Withdraw (simple request demo â†’ backend validates min)
  $('#withdrawBtn').addEventListener('click', async (e)=>{
    e.preventDefault();
    const amount = prompt('Withdraw à¦•à¦¤ Coins? (à¦‰à¦¦à¦¾à¦¹à¦°à¦£: 5000)');
    if(!amount) return;
    const res = await api('/api/withdraw',{ amount: Number(amount), initData: tg?.initData||'', initDataUnsafe: tg?.initDataUnsafe||null });
    alert(res.message || (res.success?'Requested âœ…':'Failed âŒ'));
  });

  // Claim buttons: load ad â†’ wait 5s â†’ claim
  document.querySelectorAll('.claim').forEach(btn=>{
    btn.addEventListener('click', async (e)=>{
      e.preventDefault();
      const amt = Number(btn.dataset.amount);
      const adType = btn.dataset.ad; // 'banner' | 'native' | ''
      const box = adType ? document.getElementById(adType) : null;

      if(adType && box){
        box.innerHTML = 'â³ Loading adâ€¦';
        // Inject correct ad code:
        if(adType === 'banner'){
          // Adsterra Banner 300x250 (your key + invoke)
          const s1 = document.createElement('script');
          s1.type='text/javascript';
          s1.innerHTML = `
            atOptions = {
              'key' : '6928b0f5b1a27066c76882257e555423',
              'format' : 'iframe', 'height' : 250, 'width' : 300, 'params' : {}
            };
          `;
          const s2 = document.createElement('script');
          s2.type='text/javascript';
          s2.src='//www.highperformanceformat.com/6928b0f5b1a27066c76882257e555423/invoke.js';
          box.innerHTML=''; box.appendChild(s1); box.appendChild(s2);
        }
        if(adType === 'native'){
          const s = document.createElement('script');
          s.async=true; s.setAttribute('data-cfasync','false');
          s.src='//pl25115346.profitableratecpm.com/ca1b8379ef33060d43ac0c3db8e8035e/invoke.js';
          box.innerHTML=''; box.appendChild(s);
        }
        // enforce watch time
        await new Promise(r=>setTimeout(r, 5000));
      }

      // Now call backend to claim (with cooldown & auth)
      const res = await api('/api/claim',{ amount: amt, type: adType||'task', initData: tg?.initData||'', initDataUnsafe: tg?.initDataUnsafe||null });
      if(!res.success){ alert(res.message||'Claim failed'); return; }
      setBalance(res.coins);
      alert('âœ… +'+amt+' coins added!');
    });
  });

  boot();
</script>
</body>
</html>
